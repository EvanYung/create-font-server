<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>字体编辑器DEMO</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="css/index.css" />
    <script src="js/fabric.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <style>
      @font-face {
        font-family: "createFont";
        src: url("font/createFont.eot");
        src: url("font/createFont.eot?#iefix") format("embedded-opentype"),
          url("font/createFont.woff") format("woff"),
          url("font/createFont.ttf") format("truetype"),
          url("font/createFont.svg#iconfont") format("svg");
      }
      h2,
      h3,
      input,
      div {
        font-family: "createFont", "宋体";
      }
      .big {
        font-size: 20px;
        padding: 20px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="container" style="background: #ededed">
      <div class="row clearfix">
        <div id="div"></div>

        <div class="col-md-12 column">
          <h3>字体编辑器 &#xDB44;</h3>
          <div class="row clearfix">
            <div class="col-md-6 column">
              <h3>视图区</h3>
              <div class="canvasBox">
                <canvas id="canvasObj" width="500" height="500"></canvas>
              </div>
            </div>
            <div class="col-md-6 column">
              <h3 class="navbar-form">功能</h3>
              <div class="navbar-form">
                <button
                  type="button"
                  class="btn btn-default btn-primary"
                  id="rest"
                >
                  重置
                </button>
              </div>
              <div class="navbar-form" role="search">
                <h4>插入字</h4>

                <div class="form-group">
                  <input
                    type="text"
                    class="form-control"
                    maxlength="1"
                    id="text"
                  />
                </div>
                <button type="submit" class="btn btn-default" id="insert">
                  插入
                </button>
              </div>

              <div class="navbar-form">
                <h4>存入字体对应的组合字</h4>
                <div class="form-group">
                  <input
                    type="text"
                    class="form-control"
                    maxlength="1"
                    id="groupText"
                  />
                </div>
                <p></p>
                <button
                  type="button"
                  class="btn btn-default btn-success"
                  id="down"
                >
                  提交
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    function setTxt() {
      $.get("/getAll", function (res) {
        var str = "";
        $.each(res.data, function (a, b) {
          str +=
            '<h2 class="big">' + b.code + "对应组合是：" + b.group + "</h2>";
        });
        $("#div").html(str);
      });
    }

    setTxt();

    (function () {
      fabric.Object.prototype.originX = fabric.Object.prototype.originY =
        "center";
      fabric.Object.prototype.transparentCorners = false;

      var canvas = new fabric.Canvas("canvasObj");

      $("#insert").click(function () {
        var getText = $("#text").val();
        if (getText == "") {
          alert("错误！请输入一个要插入的字");
        } else {
          console.log(getText);
          var textbox = new fabric.Text(getText, {
            left: 250,
            top: 250,
            width: 400,
            fontSize: 400,
          });
          canvas.add(textbox).setActiveObject(textbox);
          $("#text").val("");
          var oldText = $("#groupText").val();
          $("#groupText").val(oldText + getText);
        }
      });

      function download(url, name) {
        // make the link. set the href and download. emulate dom click
        $("<a>").attr({ href: url, download: name })[0].click();
      }

      function downloadFabric(canvas, name) {
        //  convert the canvas to a data url and download it.
        download(canvas.toDataURL(), name + ".png");
      }

      $("#down").click(function () {
        var oldText = $("#groupText").val();

        const fontSvg = canvas.toSVG();
        // const fontSvg = `<?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="图形" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve"><path fill="#272636" d="M918.096679 700.033358c-214.35423 178.625939-404.892703-77.405091-404.892703-77.405091C316.710788 857.819345 97.891297 680.679758 97.891297 680.679758-86.680048 512.470691 96.404945 300 96.404945 300c232.215273-310.728145 601.382788-463.350691 601.382788-463.350691 41.679903 363.2128 166.719612 303.665648 273.898279 518.032291C1078.861576 569.03583 918.096679 700.033358 918.096679 700.033358zM779.70463 331.843297c-62.426764-124.819394-135.226958-90.164752-159.511273-301.679709 0 0-214.956218 88.895612-350.208 269.836412 0 0-106.641842 123.736436 0.859539 221.680485 0 0 127.435248 103.175758 241.8688-33.795103 0 0 110.97057 149.113018 235.774448 45.074618C748.491248 532.963103 842.134497 456.672 779.70463 331.843297z" transform="translate(0, 812) scale(1, -1)"/></svg>`;

        console.log("🚀 ~ file: index.html ~ line 154 ~ fontSvg", fontSvg);

        setTimeout(function () {
          $.ajax({
            url: "/saveFile",
            type: "post",
            data: {
              fontSvg,
              name: oldText,
            },
            success: function (res) {
              if (res.message == "Success") {
                setTxt();
                var setPin = parseInt(Math.random() * 999999999);
                var styleTxt =
                  "    @font-face {\n" +
                  '      font-family: "createFont";\n' +
                  '      src: url("font/createFont.eot?' +
                  setPin +
                  '");\n' +
                  '      src: url("font/createFont.eot?#iefix&' +
                  setPin +
                  '") format("embedded-opentype"), url("font/createFont.woff?' +
                  setPin +
                  '") format("woff"), url("font/createFont.ttf?' +
                  setPin +
                  '") format("truetype"), url("font/createFont.svg#iconfont&' +
                  setPin +
                  '") format("svg")\n' +
                  "    }";

                addCssByStyle(styleTxt);
              }
            },
            error: function (err) {},
          });
        }, 1000);
      });
      $("#rest").click(function () {
        canvas.clear();
        $("#groupText").val("");
        $("#text").val("");
      });
    })();

    function addCssByStyle(cssString) {
      var doc = document;
      var style = doc.createElement("style");
      style.setAttribute("type", "text/css");

      if (style.styleSheet) {
        // IE
        style.styleSheet.cssText = cssString;
      } else {
        // w3c
        var cssText = doc.createTextNode(cssString);
        style.appendChild(cssText);
      }

      var heads = doc.getElementsByTagName("head");
      if (heads.length) {
        heads[0].appendChild(style);
      } else {
        doc.documentElement.appendChild(style);
      }
    }
  </script>
</html>
